# .github/workflows/love-cron.yml
name: ğŸ Python Love Meter Cron

on:
  schedule:
    - cron: '0 8-22/2 * * *'  # Every 2 hours 8AM-10PM UTC
  workflow_dispatch:  # Manual trigger
  push:
    branches: [ main ]

jobs:
  love-check:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to push changes
    
    steps:
      - name: ğŸ“¥ Checkout with token
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # Fetch all history
    
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          pip install pyjokes
          echo "PyJokes $(pip show pyjokes | grep Version)"
      
      - name: ğŸ’– Run Love Meter
        id: love
        run: |
          echo "::group::ğŸ² Running Python Love Meter"
          python love_meter.py
          echo "::endgroup::"
          
          # Extract level from output
          if grep -q "ğŸ’–" result.txt; then
            echo "level=LOVE" >> $GITHUB_OUTPUT
            echo "emoji=ğŸ’–" >> $GITHUB_OUTPUT
          elif grep -q "ğŸ¤" result.txt; then
            echo "level=LIKE" >> $GITHUB_OUTPUT
            echo "emoji=ğŸ¤" >> $GITHUB_OUTPUT
          else
            echo "level=SEGFAULT" >> $GITHUB_OUTPUT
            echo "emoji=ğŸ’”" >> $GITHUB_OUTPUT
          fi
          
          # Extract chance
          CHANCE=$(grep -o "Chance: [0-9.]*%" result.txt | head -1 | cut -d' ' -f2 | tr -d '%')
          echo "chance=$CHANCE" >> $GITHUB_OUTPUT
      
      - name: ğŸ“ Commit and Push Result
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if files changed
          if git status --porcelain | grep -q "result.txt\|love_result.json"; then
            echo "ğŸ“ Changes detected, committing..."
            git add result.txt love_result.json
            git commit -m "ğŸ’– Love update: ${{ steps.love.outputs.level }} (${{ steps.love.outputs.chance }}%)"
            
            # Push with token
            git push https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git HEAD:${{ github.ref }}
            echo "âœ… Pushed changes"
          else
            echo "ğŸ“ No changes to commit"
          fi
      
      - name: ğŸ“Š Update Workflow Status
        if: always()
        run: |
          echo "ğŸ Workflow completed!"
          echo "Result: ${{ steps.love.outputs.emoji }} ${{ steps.love.outputs.level }}"
          echo "Chance: ${{ steps.love.outputs.chance }}%"
          echo "Time: $(date -u +'%H:%M UTC')"
          echo ""
          echo "View result at:"
          echo "â€¢ https://github.com/${{ github.repository }}/blob/main/result.txt"
          echo "â€¢ https://raw.githubusercontent.com/${{ github.repository }}/main/result.txt" 
