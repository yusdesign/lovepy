# .github/workflows/love-cron.yml
name: ðŸ Python Love Meter Cron

on:
  schedule:
    - cron: '0 8-22/2 * * *'  # Every 2 hours 8AM-10PM UTC
  workflow_dispatch:  # Manual trigger
  push:
    branches: [ main ]

jobs:
  love-check:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to push changes
    
    steps:
      - name: ðŸ“¥ Checkout with token
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # Fetch all history
    
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          pip install pyjokes
          echo "PyJokes $(pip show pyjokes | grep Version)"
      
      - name: ðŸ’– Run Love Meter
        id: love
        run: |
          echo "::group::ðŸŽ² Running Python Love Meter"
          python love_meter.py
          echo "::endgroup::"
          
          # Extract level from output
          if grep -q "ðŸ’–" result.txt; then
            echo "level=LOVE" >> $GITHUB_OUTPUT
            echo "emoji=ðŸ’–" >> $GITHUB_OUTPUT
          elif grep -q "ðŸ¤" result.txt; then
            echo "level=LIKE" >> $GITHUB_OUTPUT
            echo "emoji=ðŸ¤" >> $GITHUB_OUTPUT
          else
            echo "level=SEGFAULT" >> $GITHUB_OUTPUT
            echo "emoji=ðŸ’”" >> $GITHUB_OUTPUT
          fi
          
          # Extract chance
          CHANCE=$(grep -o "Chance: [0-9.]*%" result.txt | head -1 | cut -d' ' -f2 | tr -d '%')
          echo "chance=$CHANCE" >> $GITHUB_OUTPUT
      
      - name: ðŸ“ Update README with Results
        run: |
          echo "ðŸ“„ Updating README.md with current results..."
          
          # Read the full content of result.txt
          RESULT_CONTENT=$(cat result.txt)
          
          # Create a new README section
          CURRENT_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          # Create the updated README content
          cat > NEW_README.md << 'EOF'
# ðŸ’– Love Meter

A whimsical Python project that measures "love compatibility" with random calculations and jokes.

## ðŸ“Š Current Status

EOF
          
          # Add the result.txt content
          echo '```' >> NEW_README.md
          cat result.txt >> NEW_README.md
          echo '```' >> NEW_README.md
          
          # Add the rest of the README
          cat >> NEW_README.md << 'EOF'

**Last Updated:** $CURRENT_TIME  
*Updates every 2 hours between 8AM-10PM UTC*

## ðŸŒ Live Demo

Visit the live page: [https://yusdesign.github.io/lovepy/index.html](https://yusdesign.github.io/lovepy/index.html)

## ðŸ› ï¸ How It Works

1. The script runs every 2 hours via GitHub Actions
2. Generates random "compatibility" scores
3. Adds a random programming joke
4. Updates both `result.txt` and this README automatically

## ðŸ“ Project Structure

- `love_meter.py` - Main Python script
- `result.txt` - Latest results (updated automatically)
- `love_result.json` - JSON version of results
- `.github/workflows/` - GitHub Actions configuration

## ðŸ”§ Manual Trigger

You can manually run the love meter:
1. Go to **Actions** â†’ **ðŸ Python Love Meter Cron**
2. Click **Run workflow**
3. Select **main** branch

## ðŸ“ˆ History

View complete history in [GitHub Actions](https://github.com/yusdesign/lovepy/actions)

---

*Made with ðŸ’– and random numbers*
EOF
          
          # Replace the variables
          sed -i "s/\$CURRENT_TIME/$CURRENT_TIME/" NEW_README.md
          
          # Replace the old README
          mv NEW_README.md README.md
          
          echo "âœ… README.md updated with current results"
      
      - name: ðŸ“ Commit and Push All Changes
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if files changed
          echo "ðŸ” Checking for changes..."
          git status
          
          if git status --porcelain | grep -q "result.txt\|love_result.json\|README.md"; then
            echo "ðŸ“ Changes detected, committing..."
            git add result.txt love_result.json README.md
            git commit -m "ðŸ’– Love update: ${{ steps.love.outputs.level }} (${{ steps.love.outputs.chance }}%)"
            
            # Push with token
            git push https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git HEAD:${{ github.ref }}
            echo "âœ… Pushed all changes (result.txt, love_result.json, README.md)"
          else
            echo "ðŸ“ No changes to commit"
          fi
      
      - name: ðŸ“Š Update Workflow Status
        if: always()
        run: |
          echo "ðŸ Workflow completed!"
          echo "Result: ${{ steps.love.outputs.emoji }} ${{ steps.love.outputs.level }}"
          echo "Chance: ${{ steps.love.outputs.chance }}%"
          echo "Time: $(date -u +'%H:%M UTC')"
          echo ""
          echo "ðŸ“‹ Files updated:"
          echo "â€¢ result.txt - https://github.com/${{ github.repository }}/blob/main/result.txt"
          echo "â€¢ README.md - https://github.com/${{ github.repository }}/blob/main/README.md"
          echo "â€¢ love_result.json - https://github.com/${{ github.repository }}/blob/main/love_result.json"
          echo ""
          echo "ðŸŒ Live page: https://yusdesign.github.io/lovepy/index.html"
