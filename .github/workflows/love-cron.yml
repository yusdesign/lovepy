# .github/workflows/love-cron.yml
name: ğŸ Python Love Meter Cron

on:
  schedule:
    - cron: '0 8-22/2 * * *'  # Every 2 hours 8AM-10PM UTC
  workflow_dispatch:  # Manual trigger
  push:
    branches: [ main ]

jobs:
  love-check:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to push changes
    
    steps:
      - name: ğŸ“¥ Checkout with token
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # Fetch all history
    
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          pip install pyjokes
          echo "PyJokes $(pip show pyjokes | grep Version)"
      
      - name: ğŸ’– Run Love Meter
        id: love
        run: |
          echo "::group::ğŸ² Running Python Love Meter"
          python love_meter.py
          echo "::endgroup::"
          
          # Extract level from output
          if grep -q "ğŸ’–" result.txt; then
            echo "level=LOVE" >> $GITHUB_OUTPUT
            echo "emoji=ğŸ’–" >> $GITHUB_OUTPUT
          elif grep -q "ğŸ¤" result.txt; then
            echo "level=LIKE" >> $GITHUB_OUTPUT
            echo "emoji=ğŸ¤" >> $GITHUB_OUTPUT
          else
            echo "level=SEGFAULT" >> $GITHUB_OUTPUT
            echo "emoji=ğŸ’”" >> $GITHUB_OUTPUT
          fi
          
          # Extract chance
          CHANCE=$(grep -o "Chance: [0-9.]*%" result.txt | head -1 | cut -d' ' -f2 | tr -d '%')
          echo "chance=$CHANCE" >> $GITHUB_OUTPUT
      
      - name: ğŸ“ Update README with Results
        run: |
          echo "ğŸ“„ Updating README.md with current results..."
          
          # Read the full content of result.txt
          RESULT_CONTENT=$(cat result.txt)
          
          # Create a new README section
          CURRENT_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          # Create the updated README content - using simpler approach
          echo "# ğŸ’– Love Meter" > NEW_README.md
          echo "" >> NEW_README.md
          echo "A whimsical Python project that measures \"love compatibility\" with random calculations and jokes." >> NEW_README.md
          echo "" >> NEW_README.md
          echo "## ğŸ“Š Current Status" >> NEW_README.md
          echo "" >> NEW_README.md
          echo "\`\`\`" >> NEW_README.md
          cat result.txt >> NEW_README.md
          echo "\`\`\`" >> NEW_README.md
          echo "" >> NEW_README.md
          echo "**Last Updated:** $CURRENT_TIME" >> NEW_README.md
          echo "*Updates every 2 hours between 8AM-10PM UTC*" >> NEW_README.md
          echo "" >> NEW_README.md
          echo "## ğŸŒ Live Demo" >> NEW_README.md
          echo "" >> NEW_README.md
          echo "Visit the live page: [https://yusdesign.github.io/lovepy/index.html](https://yusdesign.github.io/lovepy/index.html)" >> NEW_README.md
          echo "" >> NEW_README.md
          echo "## ğŸ› ï¸ How It Works" >> NEW_README.md
          echo "" >> NEW_README.md
          echo "1. The script runs every 2 hours via GitHub Actions" >> NEW_README.md
          echo "2. Generates random \"compatibility\" scores" >> NEW_README.md
          echo "3. Adds a random programming joke" >> NEW_README.md
          echo "4. Updates both \`result.txt\` and this README automatically" >> NEW_README.md
          echo "" >> NEW_README.md
          echo "## ğŸ“ Project Structure" >> NEW_README.md
          echo "" >> NEW_README.md
          echo "- \`love_meter.py\` - Main Python script" >> NEW_README.md
          echo "- \`result.txt\` - Latest results (updated automatically)" >> NEW_README.md
          echo "- \`love_result.json\` - JSON version of results" >> NEW_README.md
          echo "- \`.github/workflows/\` - GitHub Actions configuration" >> NEW_README.md
          echo "" >> NEW_README.md
          echo "## ğŸ”§ Manual Trigger" >> NEW_README.md
          echo "" >> NEW_README.md
          echo "You can manually run the love meter:" >> NEW_README.md
          echo "1. Go to **Actions** â†’ **ğŸ Python Love Meter Cron**" >> NEW_README.md
          echo "2. Click **Run workflow**" >> NEW_README.md
          echo "3. Select **main** branch" >> NEW_README.md
          echo "" >> NEW_README.md
          echo "## ğŸ“ˆ History" >> NEW_README.md
          echo "" >> NEW_README.md
          echo "View complete history in [GitHub Actions](https://github.com/yusdesign/lovepy/actions)" >> NEW_README.md
          echo "" >> NEW_README.md
          echo "---" >> NEW_README.md
          echo "" >> NEW_README.md
          echo "*Made with ğŸ’– and random numbers*" >> NEW_README.md
          
          # Replace the old README
          mv NEW_README.md README.md
          
          echo "âœ… README.md updated with current results"
      
      - name: ğŸ“ Commit and Push All Changes
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if files changed
          echo "ğŸ” Checking for changes..."
          git status
          
          if git status --porcelain | grep -q "result.txt\|love_result.json\|README.md"; then
            echo "ğŸ“ Changes detected, committing..."
            git add result.txt love_result.json README.md
            git commit -m "ğŸ’– Love update: ${{ steps.love.outputs.level }} (${{ steps.love.outputs.chance }}%)"
            
            # Push with token
            git push https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git HEAD:${{ github.ref }}
            echo "âœ… Pushed all changes (result.txt, love_result.json, README.md)"
          else
            echo "ğŸ“ No changes to commit"
          fi
      
      - name: ğŸ“Š Update Workflow Status
        if: always()
        run: |
          echo "ğŸ Workflow completed!"
          echo "Result: ${{ steps.love.outputs.emoji }} ${{ steps.love.outputs.level }}"
          echo "Chance: ${{ steps.love.outputs.chance }}%"
          echo "Time: $(date -u +'%H:%M UTC')"
          echo ""
          echo "ğŸ“‹ Files updated:"
          echo "â€¢ result.txt - https://github.com/${{ github.repository }}/blob/main/result.txt"
          echo "â€¢ README.md - https://github.com/${{ github.repository }}/blob/main/README.md"
          echo "â€¢ love_result.json - https://github.com/${{ github.repository }}/blob/main/love_result.json"
          echo ""
          echo "ğŸŒ Live page: https://yusdesign.github.io/lovepy/index.html"
