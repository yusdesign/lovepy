<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Love Meter</title>
    <meta name="description" content="GitHub-powered Python love checker">
    
    <!-- NO AUTO-REFRESH META TAG -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&family=Segoe+UI&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --love: #e91e63;
            --like: #ff9800;
            --segfault: #f44336;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        .emoji {
            font-family: 'Noto Color Emoji', 'Segoe UI Emoji', sans-serif;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .result {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .love { color: var(--love); font-size: 2em; }
        .like { color: var(--like); font-size: 2em; }
        .segfault { color: var(--segfault); font-size: 2em; }
        
        .joke {
            background: #fff9c4;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #ffd600;
            font-style: italic;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .stat {
            flex: 1;
            min-width: 150px;
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .stat h3 {
            margin-top: 0;
            color: #555;
        }
        
        .history {
            margin-top: 40px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .history ul {
            list-style-type: none;
            padding: 0;
        }
        
        .history li {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .history li:last-child {
            border-bottom: none;
        }
        
        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }
        
        .refresh-info {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .github-link {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .refresh-btn {
            display: inline-block;
            margin: 10px;
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            text-decoration: none;
        }
        
        .refresh-btn:hover {
            background: #45a049;
        }
        
        @media (max-width: 600px) {
            .stats {
                flex-direction: column;
            }
            .stat {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><span class="emoji">üêç</span> Python Love Meter</h1>
        <p>Powered by GitHub Actions Cron</p>
        <p><small>Updates every 2 hours (8AM-10PM UTC)</small></p>
    </div>
    
    <div class="result">
        <div id="loveResult" class="loading">Loading love result...</div>
        <div class="joke" id="joke">Loading joke...</div>
        <div id="time">Checking time...</div>
    </div>
    
    <div class="stats">
        <div class="stat">
            <h3><span class="emoji">üé≤</span> Chance</h3>
            <div id="chance">-</div>
        </div>
        <div class="stat">
            <h3><span class="emoji">‚è∞</span> Last Check</h3>
            <div id="lastCheck">-</div>
        </div>
        <div class="stat">
            <h3><span class="emoji">üìà</span> Next Check</h3>
            <div id="nextCheck">-</div>
        </div>
    </div>
    
    <div class="refresh-info">
        <p><strong>Note:</strong> Data updates every 2 hours via GitHub Actions</p>
        <p>Next automatic update: <span id="nextUpdateTime">calculating...</span></p>
        <button class="refresh-btn" onclick="refreshData()">
            <span class="emoji">üîÑ</span> Check for Updates
        </button>
        <p><small>Or refresh the page manually</small></p>
    </div>
    
    <div class="history">
        <h3><span class="emoji">üìú</span> Recent History</h3>
        <div id="history" class="loading">Loading history...</div>
    </div>
    
    <div class="github-link">
        <p>
            <a href="https://github.com/yusdesign/lovepy" target="_blank" class="refresh-btn">
                <span class="emoji">üíñ</span> View on GitHub
            </a>
            <a href="https://github.com/yusdesign/lovepy/actions" target="_blank" class="refresh-btn">
                <span class="emoji">‚ö°</span> View Workflow Runs
            </a>
        </p>
    </div>
    
    <script>
        // Store last update time
        let lastUpdateTime = null;
        
        // Fetch and display the result
        async function loadLoveResult() {
            try {
                // Load from result.txt with cache busting
                const response = await fetch('result.txt?' + new Date().getTime());
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const text = await response.text();
                
                if (!text || text.trim() === '') {
                    throw new Error('Empty result.txt');
                }
                
                // Parse result
                const lines = text.split('\n').filter(line => line.trim() !== '');
                
                // Find relevant lines
                const chanceLine = lines.find(l => l.includes('üé≤'));
                const jokeLine = lines.find(l => l.includes('üòÇ'));
                const timeLine = lines.find(l => l.includes('‚è∞'));
                
                // Get the first line as main result
                const firstLine = lines[0] || '';
                
                // Update DOM
                const loveResultEl = document.getElementById('loveResult');
                loveResultEl.innerHTML = `<span class="${firstLine.includes('üíñ') ? 'love' : firstLine.includes('ü§ù') ? 'like' : 'segfault'} emoji">
                    ${firstLine}
                </span>`;
                loveResultEl.className = '';
                
                document.getElementById('joke').textContent = jokeLine ? jokeLine.replace('üòÇ ', '') : 'No joke found this time';
                document.getElementById('chance').textContent = chanceLine ? chanceLine.replace('üé≤ ', '') : '-';
                
                const lastCheckEl = document.getElementById('lastCheck');
                lastCheckEl.textContent = timeLine ? timeLine.replace('‚è∞ ', '') : '-';
                
                document.getElementById('time').textContent = timeLine || '';
                
                // Calculate next check time (2 hours from last)
                if (timeLine) {
                    try {
                        const timeStr = timeLine.replace('‚è∞ ', '');
                        lastUpdateTime = new Date(timeStr);
                        if (!isNaN(lastUpdateTime)) {
                            const nextCheckTime = new Date(lastUpdateTime.getTime() + 2 * 60 * 60 * 1000);
                            document.getElementById('nextCheck').textContent = 
                                nextCheckTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                            
                            // Calculate next scheduled update (aligned to 2-hour intervals)
                            updateNextScheduledTime();
                        }
                    } catch (e) {
                        console.warn('Could not parse time:', e);
                    }
                }
                
            } catch (error) {
                console.error('Error loading result:', error);
                document.getElementById('loveResult').innerHTML = 
                    '<span class="segfault">‚ùå Error loading result</span>';
                document.getElementById('joke').textContent = 'Please check back later';
            }
        }
        
        // Calculate next scheduled update (aligned to cron schedule: 8,10,12,14,16,18,20,22 UTC)
        function updateNextScheduledTime() {
            const now = new Date();
            const currentHour = now.getUTCHours();
            
            // Scheduled hours: 8,10,12,14,16,18,20,22 UTC
            const scheduledHours = [8, 10, 12, 14, 16, 18, 20, 22];
            
            // Find next scheduled hour
            let nextHour = scheduledHours.find(h => h > currentHour);
            
            // If no more today, use first hour tomorrow
            if (!nextHour) {
                nextHour = scheduledHours[0];
                now.setUTCDate(now.getUTCDate() + 1);
            }
            
            now.setUTCHours(nextHour, 0, 0, 0);
            
            document.getElementById('nextUpdateTime').textContent = 
                now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) + ' UTC';
        }
        
        // Load commit history
        async function loadHistory() {
            try {
                const response = await fetch('https://api.github.com/repos/yusdesign/lovepy/commits?path=result.txt&per_page=5');
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                const commits = await response.json();
                
                if (!commits || !Array.isArray(commits)) {
                    throw new Error('Invalid response from GitHub');
                }
                
                let historyHTML = '<ul>';
                commits.forEach(commit => {
                    const date = new Date(commit.commit.committer.date);
                    const msg = commit.commit.message;
                    const shortHash = commit.sha.substring(0, 7);
                    
                    historyHTML += `
                        <li>
                            <strong>${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</strong><br>
                            ${msg} 
                            <small>(<a href="https://github.com/yusdesign/lovepy/commit/${commit.sha}" target="_blank">${shortHash}</a>)</small>
                        </li>
                    `;
                });
                historyHTML += '</ul>';
                
                document.getElementById('history').innerHTML = historyHTML;
                document.getElementById('history').className = '';
                
            } catch (error) {
                console.error('Error loading history:', error);
                document.getElementById('history').innerHTML = 
                    '<p>Could not load history. <a href="https://github.com/yusdesign/lovepy/actions" target="_blank">Check workflow runs</a></p>';
                document.getElementById('history').className = '';
            }
        }
        
        // Manual refresh function
        function refreshData() {
            const btn = event?.target || document.querySelector('.refresh-btn');
            const originalText = btn.innerHTML;
            
            btn.innerHTML = '<span class="emoji">‚è≥</span> Checking...';
            btn.disabled = true;
            
            console.log('Manual refresh triggered at:', new Date().toLocaleTimeString());
            
            // Reload both data sources
            Promise.all([loadLoveResult(), loadHistory()])
                .then(() => {
                    btn.innerHTML = '<span class="emoji">‚úÖ</span> Updated!';
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }, 2000);
                })
                .catch(error => {
                    console.error('Refresh failed:', error);
                    btn.innerHTML = '<span class="emoji">‚ùå</span> Failed';
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }, 2000);
                });
        }
        
        // Load everything on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded at:', new Date().toLocaleTimeString());
            loadLoveResult();
            loadHistory();
            
            // Update the "next update" time
            updateNextScheduledTime();
        });
    </script>
</body>
</html>
